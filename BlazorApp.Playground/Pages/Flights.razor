
@page "/flight"

@using System.Collections
@using System.Diagnostics
@using BlazorApp.Playground.Data


<div style="height: 300px; overflow-y: scroll">
    
    <Virtualize Context="flight"  ItemsProvider="@LoadAllFlights">
        <FlightSummary  Flight="@flight"  @key="flight.FlightId" Details="@flight.Summary" />
    </Virtualize>
</div>

@code {
    
    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }
    
    public async ValueTask<ItemsProviderResult<Flight>> LoadAllFlights(ItemsProviderRequest request)
    {
        var total = FlightService.allFlights.Length;
        
        Debug.WriteLine($"startIdx={request.StartIndex}, requestCount={request.Count}");

        var numFlights = Math.Min(request.Count, total - request.StartIndex);
        var flights = await FlightService.GetChunk(request.StartIndex, numFlights, request.CancellationToken);

        return new ItemsProviderResult<Flight>(flights, total);
    }

    private class FlightService
    {
        public static Flight[] allFlights = Enumerable.Range(1, 10_000).Select(FlightBuilder.Build).ToArray();


        public static async Task<IEnumerable<Flight>> GetChunk(int startIdx, int chunkSize, CancellationToken ct)
        {
            return new ArraySegment<Flight>(allFlights, startIdx, chunkSize);
        }
    }

    private class FlightBuilder
    {
        private static Random random = new Random();

        public static Flight Build(int id)
        {
            return new Flight(id, RandomString(10));
        }

        public static string RandomString(int length)
        {
            const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            return new string(Enumerable.Repeat(chars, length)
                .Select(s => s[random.Next(s.Length)]).ToArray());
        }
    }

   

}
